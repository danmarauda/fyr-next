# GitLab CI/CD Pipeline for Fyr Next.js Application
# Multi-environment deployment: dev -> staging -> production

stages:
    - validate
    - test
    - build
    - deploy

variables:
    NODE_VERSION: '18'
    PNPM_VERSION: '8'
    CACHE_KEY: '$CI_COMMIT_REF_SLUG'

# Cache dependencies for faster builds
cache:
    key: $CACHE_KEY
    paths:
        - .pnpm-store/
        - node_modules/
        - packages/*/node_modules/
        - .next/cache/

# Base image for all jobs
image: node:18

before_script:
    - corepack enable
    - corepack prepare pnpm@latest --activate
    - pnpm config set store-dir .pnpm-store

# ==========================================
# VALIDATION STAGE
# ==========================================

validate:deps:
    stage: validate
    script:
        - pnpm install --frozen-lockfile
        - pnpm audit --audit-level moderate
    artifacts:
        reports:
            dependency_scanning: gl-dependency-scanning-report.json
    only:
        - branches
    tags:
        - validate

validate:lint:
    stage: validate
    script:
        - pnpm install --frozen-lockfile
        - pnpm lint
    dependencies:
        - validate:deps
    only:
        - branches
    tags:
        - validate

validate:typecheck:
    stage: validate
    script:
        - pnpm install --frozen-lockfile
        - pnpm run typecheck || echo "No typecheck script found"
    dependencies:
        - validate:deps
    only:
        - branches
    tags:
        - validate

# ==========================================
# TEST STAGE
# ==========================================

test:unit:
    stage: test
    script:
        - pnpm install --frozen-lockfile
        - pnpm test || echo "No tests configured yet"
    coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
    artifacts:
        reports:
            junit: junit.xml
            coverage_report:
                coverage_format: cobertura
                path: coverage/cobertura-coverage.xml
    dependencies:
        - validate:deps
    only:
        - branches
    tags:
        - test

test:build:
    stage: test
    script:
        - pnpm install --frozen-lockfile
        - pnpm build
    artifacts:
        paths:
            - .next/
        expire_in: 1 hour
    dependencies:
        - validate:deps
    only:
        - branches
    tags:
        - test

# ==========================================
# DEPLOY STAGE
# ==========================================

deploy:dev:
    stage: deploy
    environment:
        name: development
        url: https://fyr-next-dev.vercel.app
        on_stop: stop:dev
    script:
        - echo "Deploying to development environment"
        # Install Vercel CLI
        - npm i -g vercel
        # Pull existing Vercel configuration with team scope
        - vercel pull --yes --environment=development --token=$VERCEL_TOKEN --team=$VERCEL_TEAM_ID
        # Build project
        - pnpm build
        # Deploy to Vercel with team scope
        - vercel deploy --prebuilt --token=$VERCEL_TOKEN --team=$VERCEL_TEAM_ID
    dependencies:
        - test:build
    only:
        - dev
    when: manual
    tags:
        - deploy

deploy:staging:
    stage: deploy
    environment:
        name: staging
        url: https://fyr-next-staging.vercel.app
        on_stop: stop:staging
    script:
        - echo "Deploying to staging environment"
        # Install Vercel CLI
        - npm i -g vercel
        # Pull existing Vercel configuration with team scope
        - vercel pull --yes --environment=staging --token=$VERCEL_TOKEN --team=$VERCEL_TEAM_ID
        # Build project
        - pnpm build
        # Deploy to Vercel with team scope
        - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN --team=$VERCEL_TEAM_ID
    dependencies:
        - test:build
    only:
        - staging
    when: manual
    tags:
        - deploy

deploy:production:
    stage: deploy
    environment:
        name: production
        url: https://fyr-next.vercel.app
    script:
        - echo "Deploying to production environment"
        # Install Vercel CLI
        - npm i -g vercel
        # Pull existing Vercel configuration with team scope
        - vercel pull --yes --environment=production --token=$VERCEL_TOKEN --team=$VERCEL_TEAM_ID
        # Build project
        - pnpm build
        # Deploy to Vercel with team scope
        - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN --team=$VERCEL_TEAM_ID
    dependencies:
        - test:build
    only:
        - main
    when: manual
    tags:
        - deploy

# ==========================================
# ENVIRONMENT STOP JOBS
# ==========================================

stop:dev:
    stage: deploy
    environment:
        name: development
        action: stop
    script:
        - echo "Stopping development environment"
        - npm i -g vercel
        - vercel rm --yes --token=$VERCEL_TOKEN
    only:
        - dev
    when: manual
    tags:
        - deploy

stop:staging:
    stage: deploy
    environment:
        name: staging
        action: stop
    script:
        - echo "Stopping staging environment"
        - npm i -g vercel
        - vercel rm --yes --token=$VERCEL_TOKEN
    only:
        - staging
    when: manual
    tags:
        - deploy

# ==========================================
# SECURITY & QUALITY
# ==========================================

security:scan:
    stage: validate
    script:
        - pnpm install --frozen-lockfile
        - echo "Running security scan"
        # Add security scanning tools here
        # - npm audit --audit-level moderate
    artifacts:
        reports:
            security: gl-security-report.json
    dependencies:
        - validate:deps
    only:
        - branches
    allow_failure: true
    tags:
        - security

# ==========================================
# PERFORMANCE
# ==========================================

performance:lighthouse:
    stage: test
    script:
        - echo "Running Lighthouse performance tests"
        # Add Lighthouse CI here
        # - npm install -g @lhci/cli
        # - lhci autorun
    artifacts:
        reports:
            performance: performance-report.json
    dependencies:
        - deploy:staging
    only:
        - staging
    allow_failure: true
    tags:
        - performance
